<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for middleware.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="prettify.css" />
    <link rel="stylesheet" href="base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="index.html">All files</a> middleware.ts
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">83.02% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>44/53</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">79.17% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>38/48</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/11</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">94.87% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>37/39</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">20x</span>
<span class="cline-any cline-yes">15x</span>
<span class="cline-any cline-yes">15x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13x</span>
<span class="cline-any cline-yes">13x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import {Request, Response, NextFunction} from 'express'
import {Context} from 'koa'
import {Server} from 'hapi'
import * as request from 'request'
import {IncomingMessage, ServerResponse} from "http";
&nbsp;
export class MiddlewareParams {
    endpoint: string;
    uri: string;
    psk: string;
    dumpTraffic: boolean;
}
&nbsp;
export function makeExpressMiddleware(params: MiddlewareParams) {
    return function (req: Request, res: Response, next: NextFunction) {
        if (!params.uri || req.path != params.endpoint) next();
        else <span class="missing-if-branch" title="if path not taken" >I</span>if (req.method != 'GET' &amp;&amp; req.method != 'POST') <span class="cstat-no" title="statement not covered" >next();</span>
        else if (req.headers['x-engine-from'] === params.psk) next();
        else proxyRequest(params, req, res);
    }
}
&nbsp;
export function makeConnectMiddleware(params: MiddlewareParams) {
    return function (req: any, res: any, next: any) {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!params.uri || req.originalUrl != params.endpoint) <span class="cstat-no" title="statement not covered" >next();</span>
        else <span class="missing-if-branch" title="if path not taken" >I</span>if (req.method != 'GET' &amp;&amp; req.method != 'POST') <span class="cstat-no" title="statement not covered" >next();</span>
        else if (req.headers['x-engine-from'] === params.psk) next();
        else proxyRequest(params, req, res);
    }
}
&nbsp;
export function makeKoaMiddleware(params: MiddlewareParams) {
    return function (ctx: Context, next: () =&gt; Promise&lt;any&gt;) {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!params.uri || ctx.originalUrl != params.endpoint) <span class="cstat-no" title="statement not covered" >return next();</span>
        else if (ctx.req.headers['x-engine-from'] === params.psk) return next();
        else <span class="missing-if-branch" title="if path not taken" >I</span>if (ctx.req.method != 'GET' &amp;&amp; ctx.req.method != 'POST') <span class="cstat-no" title="statement not covered" >return next();</span>
        else return new Promise((resolve) =&gt; {
                ctx.req.pipe(request(params.uri + params.endpoint, (error, response, body) =&gt; {
                    <span class="missing-if-branch" title="else path not taken" >E</span>if (response.statusCode) ctx.response.status = response.statusCode;
                    ctx.response.set(JSON.parse(JSON.stringify(response.headers)));
                    ctx.response.body = body;
                    resolve();
                }));
            });
    }
}
&nbsp;
&nbsp;
export function instrumentHapi(server: Server, params: MiddlewareParams) {
    server.ext('onRequest', (req, reply) =&gt; {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!params.uri) <span class="cstat-no" title="statement not covered" >return reply.continue();</span>
        const path = req.url.path;
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!path || path != params.endpoint) <span class="cstat-no" title="statement not covered" >return reply.continue();</span>
        else if (req.method !== 'get' &amp;&amp; req.method !== 'post') return reply.continue();
        else if (req.headers['x-engine-from'] === params.psk) return reply.continue();
        else proxyRequest(params, req.raw.req, req.raw.res);
    });
}
&nbsp;
function proxyRequest(params: MiddlewareParams, req: IncomingMessage, res: ServerResponse) {
    <span class="missing-if-branch" title="if path not taken" >I</span>if (params.dumpTraffic) {
<span class="cstat-no" title="statement not covered" >        req.pipe(process.stdout);</span>
    }
&nbsp;
    let proxyRes = req.pipe(request(params.uri + params.endpoint));
    <span class="missing-if-branch" title="if path not taken" >I</span>if (params.dumpTraffic) {
<span class="cstat-no" title="statement not covered" >        proxyRes.pipe(process.stdout);</span>
    }
    proxyRes.pipe(res);
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Sat Oct 07 2017 13:13:16 GMT-0400 (EDT)
</div>
</div>
<script src="prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="sorter.js"></script>
</body>
</html>
